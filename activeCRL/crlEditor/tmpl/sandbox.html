<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" href="/js/themes/joint.css" />
<link rel="stylesheet" href="/js/themes/crlEditor.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
<script src="/js/lodash.js"></script>
<script src="/js/backbone.js"></script>
<script src="/js/joint.js"></script>
<script src="/js/joint.shapes.uml.js"></script>
<script src="/js/jstree.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="/js/crlEditor.js"></script>
<script>
	$(function() {
		// 6 create an instance when the DOM is ready
		$('#uOfD').jstree({
			'core' : {
				'check_callback' : true
			}
		});
		// 7 bind to events triggered on the tree
		$('#uOfD').on("changed.jstree", function(e, data) {
			console.log(data.instance);
		});
	});
</script>
<script>
	$(function() {
		crlEditor.GetTreeManager().InitializeTree()
	});
</script>

<script>
	var getMyTargetTextWidth = function(selectedObject) {
		var font = getComputedStyle(selectedObject[0]).font;
		var testCanvas = document.getElementById("testCanvas");
		console.log(testCanvas);
		var testCanvasCtx = testCanvas.getContext("2d");
		testCanvasCtx.font = font;
		var txt = selectedObject.val();
		var width = testCanvasCtx.measureText(txt).width;
		testCanvasCtx.fillText("width:" + width, 10, 50);
		testCanvasCtx.fillText(txt, 10, 100);
		console.log(width);
		return width;
	}
</script>

<script type="text/javascript">
	var myTarget
	$(function() {
		var graph = new joint.dia.Graph;
		var paper = new joint.dia.Paper({
			el : $('#diagram'),
			width : 650,
			height : 400,
			gridSize : 1,
			model : graph
		});

		// Create a custom element.
		// ------------------------

		joint.shapes.html = {};
		joint.shapes.html.Element = joint.shapes.basic.Rect.extend({
			defaults : joint.util.deepSupplement({
				type : 'html.Element',
				attrs : {
					rect : {
						stroke : 'none',
						'fill-opacity' : 0
					}
				}
			}, joint.shapes.basic.Rect.prototype.defaults)
		});

		// Create a custom view for that element that displays an HTML div above it.
		// -------------------------------------------------------------------------

		joint.shapes.html.ElementView = joint.dia.ElementView
				.extend({

					template : [
							'<div class="html-element">',
							'<button class="delete">x</button>',
							'<label></label>',
							'<span></span>',
							'<br/>',
							'<select><option>--</option><option>one</option><option>two</option></select>',
							'<input type="text" value="I\'m HTML input" />',
							'</div>' ].join(''),

					initialize : function() {
						_.bindAll(this, 'updateBox');
						joint.dia.ElementView.prototype.initialize.apply(this,
								arguments);

						this.$box = $(_.template(this.template)());
						// Prevent paper from handling pointerdown.
						this.$box.find('input,select').on('mousedown click',
								function(evt) {
									evt.stopPropagation();
								});
						// This is an example of reacting on the input change and storing the input data in the cell model.
						this.$box.find('input').on(
								'change',
								_.bind(function(evt) {
									this.model
											.set('input', $(evt.target).val());
									console.log("Updated text input");
									myTarget = $(evt.target);
									console.log($(evt.target));
									var width = getMyTargetTextWidth(myTarget);
									this.model.set(`width`, width);
								}, this));
						this.$box.find('select').on(
								'change',
								_.bind(function(evt) {
									this.model.set('select', $(evt.target)
											.val());
								}, this));
						this.$box.find('select').val(this.model.get('select'));
						this.$box.find('.delete').on('click',
								_.bind(this.model.remove, this.model));
						// Update the box position whenever the underlying model changes.
						this.model.on('change', this.updateBox, this);
						// Remove the box when the model gets removed from the graph.
						this.model.on('remove', this.removeBox, this);

						this.updateBox();
					},
					render : function() {
						joint.dia.ElementView.prototype.render.apply(this,
								arguments);
						this.paper.$el.prepend(this.$box);
						this.updateBox();
						return this;
					},
					updateBox : function() {
						// Set the position and dimension of the box so that it covers the JointJS element.
						var bbox = this.model.getBBox();
						// Example of updating the HTML with a data stored in the cell model.
						this.$box.find('label').text(this.model.get('label'));
						this.$box.find('span').text(this.model.get('select'));
						var width = getMyTargetTextWidth(this.$box.find(`input`)) + "100px";
						this.$box.find('input').css({width : width});
						this.$box.css({
							width : width,
							height : bbox.height,
							left : bbox.x,
							top : bbox.y,
							transform : 'rotate('
									+ (this.model.get('angle') || 0) + 'deg)'
						});
					},
					removeBox : function(evt) {
						this.$box.remove();
					}
				});

		// Create JointJS elements and add them to the graph as usual.
		// -----------------------------------------------------------

		var el1 = new joint.shapes.html.Element({
			position : {
				x : 80,
				y : 80
			},
			size : {
				width : 200,
				height : 100
			},
			label : 'I am HTML',
			select : 'one'
		});
		var el2 = new joint.shapes.html.Element({
			position : {
				x : 370,
				y : 160
			},
			size : {
				width : 170,
				height : 100
			},
			label : 'Me too',
			select : 'two'
		});
		var l = new joint.dia.Link({
			source : {
				id : el1.id
			},
			target : {
				id : el2.id
			},
			attrs : {
				'.connection' : {
					'stroke-width' : 5,
					stroke : '#34495E'
				}
			}
		});

		graph.addCells([ el1, el2, l ]);

	});
</script>

</head>
<body>
	<!-- <input id="name" type="text" value="" placeholder="What is your name ?" autofocus />
	<span id="output"></span>  -->
	<script>
		logEntry()
	</script>
	<script>
		addCallback()
	</script>
	<div class="container">
		<div class="dropdown">
			<button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">
				File <span class="caret"></span>
			</button>
			<ul class="dropdown-menu">
				<li><a href='javascript:logEntry("Open")'> Open Tree Root </a></li>
				<li><a href='javascript:logEntry("Close")'> Close Tree Root </a></li>
				<li><a href="#">JavaScript</a></li>
			</ul>
		</div>
	</div>
	<div class="container-fluid">
		<div class="row">
			<div class="col-xs-4 col-sm-3 col-md-3 col-lg-2" style="background-color: #f5ecb1;">
				<h4>Universe of Discourse</h4>
				<div id="uOfD"></div>
			</div>
			<div class="col-xs-8 col-sm-3 col-md-9 col-lg-10">
				<h4>CRL Diagram</h4>
				<div id="diagram"></div>
				<canvas id="testCanvas" width="300" height="150" style="border: 1px solid #d3d3d3;"></canvas>

			</div>
		</div>
	</div>
</body>
</html>